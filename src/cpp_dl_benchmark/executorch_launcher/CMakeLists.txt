set(executorch_DIR "${EXECUTORCH_INSTALL_DIR}/lib/cmake/ExecuTorch")

find_package(executorch REQUIRED)

file(GLOB_RECURSE HEADERS "${CMAKE_CURRENT_SOURCE_DIR}/include/*")
file(GLOB_RECURSE SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/src/*")

set(EXECUTORCH_OPTIMIZED_OPS "liboptimized_ops_lib.a")
set(EXECUTORCH_CPU_OPS "liboptimized_native_cpu_ops_lib")
set(EXECUTORCH_BACKEND_XNNPACK "libXNNPACK.a")

find_path(EXECUTORCH_OPTIMIZED_OPS_FIND ${EXECUTORCH_OPTIMIZED_OPS} HINT "${EXECUTORCH_INSTALL_DIR}/lib" CMAKE_FIND_ROOT_PATH_BOTH)
find_path(EXECUTORCH_CPU_OPS_FIND ${EXECUTORCH_CPU_OPS} HINT "${EXECUTORCH_INSTALL_DIR}/lib" CMAKE_FIND_ROOT_PATH_BOTH)
find_path(EXECUTORCH_XNNPACK_FIND ${EXECUTORCH_BACKEND_XNNPACK} HINT "${EXECUTORCH_INSTALL_DIR}/lib" CMAKE_FIND_ROOT_PATH_BOTH)

if (${EXECUTORCH_XNNPACK_FIND} STREQUAL EXECUTORCH_XNNPACK_FIND-NOTFOUND)
    set(BACKEND_DEF "DEFAULT")
else()
    set(BACKEND_DEF "XNNPACK")
endif()

list(REMOVE_ITEM EXECUTORCH_LIBRARIES extension_module) # Dynamic library not working https://github.com/pytorch/executorch/issues/8870

if (NOT ${EXECUTORCH_OPTIMIZED_OPS_FIND} STREQUAL EXECUTORCH_OPTIMIZED_OPS_FIND-NOTFOUND)
    list(REMOVE_ITEM EXECUTORCH_LIBRARIES optimized_ops_lib) 
endif()

if (NOT ${EXECUTORCH_CPU_OPS_FIND} STREQUAL EXECUTORCH_CPU_OPS_FIND_FIND-NOTFOUND)
    list(REMOVE_ITEM EXECUTORCH_LIBRARIES optimized_native_cpu_ops_lib)
endif()


message(STATUS ${EXECUTORCH_INCLUDE_DIRS})

add_launcher(NAME executorch_benchmark
    SOURCES ${SOURCES}
    HEADERS ${HEADERS}
    INCLUDE_DIRECTORIES "${CMAKE_CURRENT_SOURCE_DIR}/include"
                        "${EXECUTORCH_REPO_PATH}"
                        "${EXECUTORCH_INSTALL_DIR}/include"
    DEPENDENCIES
        -Wl,--whole-archive,--allow-multiple-definition
        ${EXECUTORCH_LIBRARIES}
        -Wl,--no-whole-archive
    DEFINITIONS EXECUTORCH_${BACKEND_DEF})